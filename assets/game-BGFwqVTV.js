import{A as Z,d as $,e as U,S as Y,f as Q,g as tt,D as N,h as et,W as it,i as st,j as ot,c as f,V as n,k as nt,M as D,O as at,l as ht,b as rt,m as ct,E as lt,L as mt,n as dt,o as F,p as b,q as k,R as z,r as ut,s as pt,t as ft}from"./js/vendor-three-mP7boBGq.js";import{P as H,I as gt,c as d,s as R,u as W,a as T,l as bt,L as wt,C as yt}from"./js/shared-BfO4yEIW.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class xt{constructor(){this.sceneContainer=document.getElementById("scene-container"),this.lose_popup=document.getElementById("lose-popup"),this.overlay=document.getElementById("overlay"),this.loading=document.getElementById("loading"),this.loadingIcon=document.getElementById("loading-icon"),this.itemIcon=document.getElementById("item-icon"),this.pause_popup=document.getElementById("pause-popup"),this.countdownElement=document.getElementById("countdown");const t=document.getElementById("return-button");t&&t.addEventListener("click",this.returnToMain)}loadingScreen(){const t=["assets_/pics/GaryRound.gif","assets_/pics/JellyJump.gif","assets_/pics/SpongeBobWalk.gif","assets_/pics/PatrickRun.gif"],e=t[Math.floor(Math.random()*t.length)];this.loadingIcon.src=e,y(this.loading)}removeLoadingScreen(){w(this.loading,1,0,!0,500)}swapItem(t){this.current_item!==t&&(console.log("debuging effects. fello from ui's item ",t),this.current_item=t,this.itemIcon.src=`assets_/pics/items/${t}.png`)}lose(){y(this.overlay,0,.5,!1,500),y(this.lose_popup,0,1,!0,500)}restart(){w(this.overlay,.5,0,!0,500),w(this.lose_popup,1,0,!0,500)}pause(){console.log("pause in ui"),y(this.overlay,0,.5,!1,500),y(this.pause_popup,0,1,!0,500)}resume(){w(this.overlay,.5,0,!0,500),w(this.pause_popup,1,0,!0,500)}async countdown(t){this.countdownElement.style.display="block";for(let e=t;e>0;e--)this.countdownElement.innerText=e.toString(),await new Promise(i=>setTimeout(i,1e3));this.countdownElement.style.display="none"}returnToMain(){window.location.href="Character.html"}}const L=document.getElementById("start-button");L&&L.addEventListener("click",()=>{L.style.display="none",Dt()});function Dt(){console.log("Game Starting..."),window.dispatchEvent(new Event("gameStart"))}function w(l,t=1,e=0,i=!0,s=500){var o=t;const a=10;var h=(t-e)*a/s,c=setInterval(function(){o<=e&&(l.style.opacity=e.toString(),l.style.filter="alpha(opacity="+e*100+")",clearInterval(c),i&&(l.style.display="none")),l.style.opacity=o.toString(),l.style.filter="alpha(opacity="+o*100+")",o-=h},a)}function y(l,t=0,e=1,i=!0,s=500){var o=t;const a=10;var h=(e-t)*a/s;i&&(l.style.display="block");var c=setInterval(function(){o>=e&&(l.style.opacity=e.toString(),l.style.filter="alpha(opacity="+e*100+")",clearInterval(c)),l.style.opacity=o.toString(),l.style.filter="alpha(opacity="+o*100+")",o+=h},a)}class g{constructor(){this.bgmAudio=null,this.collisionAudio=null,this.pickItemAudio=null,this.breakAudio=null,this.warningAudio=null,this.audioLoader=new Z,this.listener=new $}static getInstance(){return g.instance||(g.instance=new g),g.instance}getListener(){return this.listener}async loadAudio(t,e=!1,i=.5){const s=new U(this.listener);try{const o=await new Promise((a,h)=>{this.audioLoader.load(t,a,void 0,h)});return s.setBuffer(o),s.setLoop(e),s.setVolume(i),s}catch(o){throw console.error(`Error loading audio from ${t}:`,o),o}}async loadAndPlayBGM(){try{this.bgmAudio||(this.bgmAudio=await this.loadAudio("assets_/audio/the-big-heist-188391.mp3",!0)),this.bgmAudio.play()}catch(t){console.error("Error loading BGM:",t)}}async playBoundingSound(){try{this.collisionAudio||(this.collisionAudio=await this.loadAudio("assets_/audio/boing-6222.mp3",!1)),this.collisionAudio.isPlaying&&this.collisionAudio.stop(),this.collisionAudio.play()}catch(t){console.error("Error playing collision sound:",t)}}async playPickItemSound(){try{this.pickItemAudio||(this.pickItemAudio=await this.loadAudio("assets_/audio/pickItem.mp3",!1)),this.pickItemAudio.isPlaying&&this.pickItemAudio.stop(),this.pickItemAudio.play()}catch(t){console.error("Error playing pickItemAudio: ",t)}}async playBreakSound(){try{this.breakAudio||(this.breakAudio=await this.loadAudio("assets_/audio/break.mp3",!1)),this.breakAudio.isPlaying&&this.breakAudio.stop(),this.breakAudio.play()}catch(t){console.error("Error playing breakAudio: ",t)}}async playWarningSound(){try{this.warningAudio||(this.warningAudio=await this.loadAudio("assets_/audio/warning.mp3",!1)),this.warningAudio.isPlaying&&this.warningAudio.stop(),this.warningAudio.play()}catch(t){console.error("Error playing warning sound:",t)}}stopBGM(){this.bgmAudio&&this.bgmAudio.stop()}pauseBGM(){this.bgmAudio&&this.bgmAudio.pause()}resumeBGM(){this.bgmAudio&&this.bgmAudio.play()}setBGMVolume(t){this.bgmAudio&&this.bgmAudio.setVolume(Math.max(0,Math.min(1,t)))}setCollisionVolume(t){this.collisionAudio&&this.collisionAudio.setVolume(Math.max(0,Math.min(1,t)))}}class Pt{constructor(){this.scene=new Y,this.scene.background=new Q(8900346),this.addLights()}addLights(){const t=new tt(16777215,.5);this.scene.add(t);const e=new N(16777215,1);e.position.set(10,10,10),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=500,e.shadow.camera.left=-50,e.shadow.camera.right=50,e.shadow.camera.top=50,e.shadow.camera.bottom=-50;const i=new et(16777215,1,100);i.position.set(5,5,5),i.castShadow=!0;const s=new N(16777215,.5);s.position.set(-10,10,-10),s.castShadow=!0}add(t){t.mesh&&(t.mesh.castShadow=!0,t.mesh.receiveShadow=!0,this.scene.add(t.mesh))}remove(t){t.mesh&&this.scene.remove(t.mesh)}getScene(){return this.scene}}class vt{constructor(){this.renderer=new it({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=st}get domElement(){return this.renderer.domElement}render(t,e){this.renderer.render(t.getScene(),e.camera)}}class P{constructor(t,e,i){this.boundingBoxHelper=null,this.type=t,this.name=e,this.mesh=new at,this.mesh.add(i),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,new f().setFromObject(this.mesh).getSize(new n),this.boundingBoxHelper=new ht(this.mesh,16711680)}destruct(t=null){var e,i;if(t&&(this.type==="item"||this.type==="obstacle")){console.log(this.name,"is destructing");const s=new H;s.createBreakEffect(this.getCenter()),t.add(s.particles),s.addToUpdateList(t)}(e=this.mesh.parent)==null||e.remove(this.mesh),(i=this.boundingBoxHelper.parent)==null||i.remove(this.boundingBoxHelper),V(this.mesh)}rescale(t,e,i){this.mesh.scale.set(1,1,1);const s=new f().setFromObject(this.mesh),o=s.getSize(new n),a=s.getCenter(new n);new n(a.x,s.min.y,a.z);const h=t/o.x,c=e/o.y,r=i/o.z;this.mesh.scale.set(h,c,r),this.updateBoundingBox()}updateBoundingBox(){this.boundingBoxHelper&&this.boundingBoxHelper.update()}addBoundingBoxHelper(t){t.add(this.boundingBoxHelper)}addBoundingBoxHelperToThis(){this.mesh.add(this.boundingBoxHelper)}getCenter(){return new f().setFromObject(this.mesh).getCenter(new n)}getBottomCenter(){const t=new f().setFromObject(this.mesh),e=t.getCenter(new n);return new n(e.x,t.min.y,e.z)}getTopCenter(){const t=new f().setFromObject(this.mesh),e=t.getCenter(new n);return new n(e.x,t.max.y,e.z)}setPosition(t,e,i){const s=new f().setFromObject(this.mesh);s.getSize(new n);const o=s.getCenter(new n),a=new n(o.x,s.min.y,o.z),h=new n(t,e,i).sub(a);this.mesh.position.add(h),this.updateBoundingBox(),console.log(this.name,o,a,h)}rotate(t,e){this.mesh.rotation[t]+=e,this.updateBoundingBox()}setRotation(t,e,i){this.mesh.rotation.set(t,e,i),this.updateBoundingBox()}lookAt(t,e,i){this.mesh.lookAt(new n(t,e,i)),this.updateBoundingBox()}setEulerRotation(t,e,i,s="XYZ"){this.mesh.rotation.set(t,e,i,s),this.updateBoundingBox()}rotateOnAxis(t,e){this.mesh.rotateOnAxis(t.normalize(),e),this.updateBoundingBox()}}class v extends P{constructor(t,e,i){super(t,e,i.scene),this.mixer=null,this.animations=[],this.gltf=i,this.initAnimation()}initAnimation(t=0){console.log(this.name,"is initializing animation",t),this.gltf.animations&&this.gltf.animations.length>t?(console.log(this.name,"has animations"),this.mixer=new ot(this.mesh),this.animations=this.gltf.animations,this.mixer.clipAction(this.animations[t]).play(),console.log(this.name,this.animations,this.mixer)):console.log(this.name,"has no animations")}changeGLTF(t,e=0){const i=new f().setFromObject(this.mesh);i.getSize(new n);const s=i.getCenter(new n),o=new n(s.x,i.min.y,s.z);this.mesh.children.forEach(h=>{h instanceof nt||this.mesh.remove(h)}),V(this.mesh),this.mesh.add(t.scene),this.rescale(1,1,1),this.mixer=null,this.animations=[],this.gltf=t,this.setPosition(o.x,o.y,o.z),this.initAnimation(e),console.log(this.name,"is changed to",t)}animate(t){this.mixer&&this.mixer.update(t)}}function V(l){if(l instanceof D&&(l.geometry.dispose(),Array.isArray(l.material)?l.material.forEach(t=>t.dispose()):l.material&&l.material.dispose()),l.children)for(let t of l.children)V(t)}class Mt{}class Ct extends Mt{constructor(t,e=window.innerWidth/window.innerHeight,i=75,s=1e3){super(),this.cameraDistance=4,this.cameraAngle=rt.degToRad(20),this._isCustomCamera=!0,this.isShaking=!1,this.isClosingup=!1,this._camera=new ct(i,e,.1,s),this.character=t,this.thirdPersonPerspective()}get camera(){return this._camera}thirdPersonPerspective(){let t=this.character.mesh.position.x,e=this.character.mesh.position.y+this.cameraDistance,i=this.character.mesh.position.z-this.cameraDistance;this._camera.position.set(t,e,i),this._camera.lookAt(new n(this.character.mesh.position.x,this.character.mesh.position.y+this.cameraDistance/2,this.character.mesh.position.z+this.cameraDistance)),this._camera.up.set(0,1,0),this.perspective="thirdPerson"}firstPersonPerspective(){let t=this.character.mesh.position.x,e=this.character.mesh.position.y+this.cameraDistance,i=this.character.mesh.position.z;this._camera.position.set(t,e,i),this._camera.lookAt(new n(this.character.mesh.position.x,this.character.mesh.position.y,this.character.mesh.position.z+this.cameraDistance)),this._camera.up.set(0,1,0),this.perspective="firstPerson"}secondPersonPerspective(){let t=this.character.mesh.position.x+this.cameraDistance,e=this.character.mesh.position.y+this.cameraDistance,i=this.character.mesh.position.z+this.cameraDistance;this._camera.position.set(t,e,i),this._camera.lookAt(this.character.mesh.position),this._camera.up.set(0,1,0),this.perspective="secondPerson"}async closeUp(){this.isClosingup=!0;const t=this._camera.position.clone(),e=this._camera.fov,i=new n(this.character.mesh.position.x,this.character.mesh.position.y+2,this.character.mesh.position.z+3.5);await this.animateCameraPositionAndFov(i,50,200),await new Promise(s=>setTimeout(s,1e3)),await this.animateCameraPositionAndFov(t,e,200),this.isClosingup=!1}animateCameraPositionAndFov(t,e,i){return new Promise(s=>{const o=this._camera.position.clone(),a=this._camera.fov,h=performance.now(),c=r=>{const m=r-h,p=Math.min(m/i,1);this._camera.position.lerpVectors(o,t,p),this._camera.fov=a+(e-a)*p,this._camera.updateProjectionMatrix(),this._camera.lookAt(this.character.mesh.position),p<1?requestAnimationFrame(c):s()};requestAnimationFrame(c)})}update(){if(!(this.isShaking||this.isClosingup))switch(this.perspective){case"thirdPerson":this.thirdPersonPerspective();break;case"firstPerson":this.firstPersonPerspective();break;case"secondPerson":this.secondPersonPerspective();break;default:this.thirdPersonPerspective();break}}shake(t,e){this.isShaking=!0;const i=this._camera.position.clone(),s=setInterval(()=>{this._camera.position.x=i.x+(Math.random()-.5)*t,this._camera.position.y=i.y+(Math.random()-.5)*t,this._camera.position.z=i.z+(Math.random()-.5)*t},1e3/60);setTimeout(()=>{clearInterval(s),this._camera.position.copy(i),this.isShaking=!1},e)}}class K extends v{constructor(t,e){super("character",t,e),this.waiting_effect=["",{duration:0,apply:i=>{},remove:i=>{}}],this.effects={},this.movableBoundary={forward:1e3,backward:-1e3,left:-1e3,right:1e3,up:1e3,down:0},this.condition="normal",this.movementUpdated=!1,this.punchingTime=0,this.delta=.05,this.defaultMaxVel=3.5,this.defaultMinVel=.1,this.defaultMaxJumpVel=4.2,this.defaultDeaccel=5,this.defaultAccelZ=1.5,this.defaultAccelX=2.5,this.defaultGravity=2,this.rescale(1,1,1),this.camera=new Ct(this)}init(){this.pos=new n(0,0,0),this.vel=new n(0,0,0),this.accel=new n(0,0,0),this.force=new n(0,0,0),this.inputHandler=new gt,this.condition="normal",this.newMovement="idle",this.updateCondition(this.condition),this.updateMovement()}onGround(){const t=new f().setFromObject(this.mesh);return Math.abs(this.movableBoundary.down-t.min.y)<this.delta}updateMovementTmp(t){this.newMovement=t}updateAcceleration(t){this.inputHandler.isKeyPressed("w")?this.accel.z=this.defaultAccelZ:this.inputHandler.isKeyPressed("s")?this.accel.z=-this.defaultAccelZ:Math.abs(this.vel.z)<this.defaultMinVel?(this.accel.z=0,this.vel.z=0):this.vel.z>0?this.accel.z=-this.defaultDeaccel:this.accel.z=this.defaultDeaccel,this.inputHandler.isKeyPressed("a")?(this.accel.x=this.defaultAccelX,this.accel.x+=this.force.x):this.inputHandler.isKeyPressed("d")?(this.accel.x=-this.defaultAccelX,this.accel.x+=this.force.x):Math.abs(this.vel.x)<this.defaultMinVel&&this.force.x==0?(this.accel.x=0,this.vel.x=0):this.vel.x>0&&this.force.x==0?this.accel.x=-this.defaultAccelX:this.vel.x<0&&this.force.x==0?this.accel.x=this.defaultAccelX:this.accel.x=this.force.x,this.inputHandler.isKeyPressed(" ")&&this.onGround()&&(this.vel.y=this.defaultMaxJumpVel/2),this.inputHandler.isKeyPressed("c")&&!this.onGround()&&(this.vel.y=-this.defaultMaxJumpVel),this.accel.y=-this.defaultGravity}updateVelocity(t){this.vel.add(this.accel.clone().multiplyScalar(t)),this.vel.x=Math.min(Math.max(this.vel.x,-this.defaultMaxVel),this.defaultMaxVel),this.vel.y=Math.min(Math.max(this.vel.y,-this.defaultMaxJumpVel),this.defaultMaxJumpVel),this.vel.z=Math.min(Math.max(this.vel.z,-this.defaultMaxVel),this.defaultMaxVel)}updatePosition(t){if(this.condition=="dance"||this.condition=="squashed"){this.vel.set(0,0,0),this.accel.set(0,0,0);return}this.mesh.position.add(this.vel.clone().multiplyScalar(t));const e=new f().setFromObject(this.mesh);for(const i in this.movableBoundary){const s=this.movableBoundary[i];i=="forward"&&e.max.z>s?(this.vel.z>0&&(this.vel.z=0),this.mesh.position.z-=e.max.z-s):i=="backward"&&e.min.z<s?(this.vel.z<0&&(this.vel.z=0),this.mesh.position.z+=s-e.min.z):i=="left"&&e.min.x<s?(this.vel.x<0&&(this.vel.x=0),this.mesh.position.x+=s-e.min.x):i=="right"&&e.max.x>s?(this.vel.x>0&&(this.vel.x=0),this.mesh.position.x-=e.max.x-s):i=="up"&&e.max.y>s?(this.vel.y>0&&(this.vel.y=0),this.mesh.position.y-=e.max.y-s):i=="down"&&e.min.y<s&&(this.vel.y<0&&(this.vel.y=0),this.mesh.position.y+=s-e.min.y)}}getMovement(){this.updateMovementTmp("walking"),this.vel.z==this.defaultMaxVel&&this.updateMovementTmp("running"),this.inputHandler.isKeyPressed("j")&&this.updateMovementTmp("punching"),this.onGround()||this.updateMovementTmp("jumping"),this.condition=="dance"&&this.updateMovementTmp("dance"),this.condition=="squashed"&&this.updateMovementTmp("squashed")}updateCondition(t){if(this.condition==t)return;this.condition=t;const e=this.updateConditionMesh(t);console.log("newgltf:",e),this.changeGLTF(e),this.initAnimation(),this.condition=="dead"?this.rescale(.5,.5,.5):this.condition=="robotic"?this.name=="spongeBob"?this.rescale(2,2,1.5):this.rescale(1.3,2.5,1.3):this.condition=="dance"?this.camera.closeUp():this.condition=="squashed"&&this.camera.shake(1,200),this.cameraShake(1,200)}updateMovement(t=0){if(this.punchingTime=Math.max(0,this.punchingTime-t),this.movement==this.newMovement||this.punchingTime>0)return;this.movement=this.newMovement;let{animationId:e}=this.updateMovementAnimation(this.movement);this.initAnimation(e),this.movement=="punching"&&(this.punchingTime=.4)}applyEffect(t,e){this.effects[t]&&this.effects[t].remove(this),this.effects[t]=e,e.apply(this)}pickEffect(t,e){this.waiting_effect=[t,e]}updateEffects(t){this.inputHandler.isKeyPressed("k")&&this.waiting_effect[0]!=""&&(this.applyEffect(this.waiting_effect[0],this.waiting_effect[1]),this.waiting_effect=["",{duration:0,apply:e=>{},remove:e=>{}}]);for(const e in this.effects){const i=this.effects[e];i.duration-=t,i.duration<=0&&(i.remove(this),delete this.effects[e])}}debugLogging(){this.condition=="robotic"&&(console.log("debug robot","position:",this.mesh.position),console.log("debug robot","box:",this.getBottomCenter()))}updateCamera(t){this.inputHandler.isKeyPressed("q")&&(this.camera.perspective="thirdPerson"),this.inputHandler.isKeyPressed("e")&&(this.camera.perspective="secondPerson"),this.camera.update()}tick(t){this.updateAcceleration(t),this.updateVelocity(t),this.updatePosition(t),this.updateBoundingBox(),this.updateEffects(t),this.updateCamera(t),this.updateMovement(t),this.animate(t),this.getMovement()}cameraShake(t,e){this.camera.shake(t,e)}reset(){this.updateCondition("normal"),this.newMovement="idle",this.updateMovement(),this.mesh.position.set(0,0,0),this.vel.set(0,0,0),this.accel.set(0,0,0)}}class zt extends K{constructor(t,e){let i={};i.normal=e.spongeBobAll,i.robotic=e.roboBob1,i.dead=e.spongeBobDraw,i.scary=e.scaryBob2,super(t,i.normal),this.gltfDict=i,this.init()}updateConditionMesh(t){let e;switch(t){case"normal":e=this.gltfDict.normal;break;case"robotic":e=this.gltfDict.robotic;break;case"dead":e=this.gltfDict.dead;break;case"scary":e=this.gltfDict.scary;break;default:e=this.gltfDict.normal;break}return e}updateMovementAnimation(t){let e=0;switch(t){case"idle":this.condition=="robotic"?e=9:this.condition=="normal"?e=20:e=0;break;case"dance":e=12;break;case"squshed":e=0;break;case"walking":this.condition=="robotic"?e=9:this.condition=="normal"?e=32:e=0;break;case"running":this.condition=="robotic"?e=9:this.condition=="normal"?e=28:e=0;break;case"jumping":this.condition=="robotic"?e=7:this.condition=="normal"?e=23:e=0;break;case"punching":this.condition=="robotic"?e=5:this.condition=="normal"?e=30:e=0;break;default:e=0;break}return{animationId:e}}}class St extends K{constructor(t,e){let i={};i.normal=e.patrickAll,i.robotic=e.patrickRobot,super(t,i.normal),this.gltfDict=i,this.init()}updateConditionMesh(t){let e;switch(t){case"normal":e=this.gltfDict.normal;break;case"robotic":e=this.gltfDict.robotic;break;default:e=this.gltfDict.normal;break}return e}updateMovementAnimation(t){let e=0;switch(t){case"idle":this.condition=="robotic"?e=0:this.condition=="normal"?e=13:e=12;break;case"dance":e=12;break;case"squashed":e=0;break;case"walking":this.condition=="robotic"?e=0:this.condition=="normal"?e=26:e=0;break;case"running":this.condition=="robotic"?e=0:this.condition=="normal"?e=4:e=0;break;case"jumping":this.condition=="robotic"?e=0:this.condition=="normal"?e=18:e=0;break;case"punching":this.condition=="robotic"?e=0:this.condition=="normal"?e=23:e=0;break;default:e=0;break}return{animationId:e}}}class A extends v{constructor(t,e){const i=d(e);super("obstacle",t,i),this.collidedCnt=0,this.colliding=!1,this.collidedThreshold=100,this.punchedTime=0,this.init()}init(){this.collidedCnt=0,this.colliding=!1,this.punchedTime=0,this.vel=new n(0,0,0)}updatePosition(t){this.mesh.position.add(this.vel.clone().multiplyScalar(t))}ensureOnGround(){this.name.includes("rock")&&this.getBottomCenter().y<=0&&(this.vel.y=0)}rebound(){this.name.includes("tiki")&&(this.getTopCenter().y<=.15&&(this.vel.y=-this.vel.y),this.getBottomCenter().y>=.1&&(this.vel.y=-this.vel.y))}jellyfishMotion(){this.name.includes("jelly_fish")&&(this.getBottomCenter().y<=1.5&&this.getBottomCenter().x<=-3&&(this.vel.y=0,this.vel.x=1),this.getBottomCenter().y<=1.5&&this.getBottomCenter().x>=3&&(this.vel.y=1,this.vel.x=0),this.getBottomCenter().y>=3&&this.getBottomCenter().x>=3&&(this.vel.y=0,this.vel.x=-1),this.getBottomCenter().y>=3&&this.getBottomCenter().x<=-3&&(this.vel.y=-1,this.vel.x=0))}tick(t){this.animate(t),this.updatePosition(t),this.updateBoundingBox(),this.ensureOnGround(),this.rebound(),this.jellyfishMotion()}}function j(l){l.traverse(t=>{if(t.isMesh){const e=t;e.castShadow=!0,e.receiveShadow=!0}})}class kt{constructor(t){this.seed=0,this.gltfDict={},this.themes=["all","normal","bikini_bottom","windy_food","vehicles","dungeon","statues","food"],this.themeDict={},this.themeDecorateDict={},this.sizeDict={},this.rotateDict={},this.velDict={},console.log("generator created"),this.gltfDict=t,this.init()}init(){this.seed=Date.now(),this.themes.forEach(t=>{this.themeDict[t]=[]});for(let t in this.gltfDict)t!="wooden_fence"&&this.themeDict.all.push(t);this.initThemes(),this.initSizeDict(),this.initRotateDict(),this.initVelDict()}initThemes(){this.themeDict.normal=["jelly_fish"],this.themeDict.bikini_bottom=["squidwardHouseTSCP","pineapple_house","lightHouseTSCP","krabTSCP","bottom","chum_bucket"],this.themeDict.windy_food=["burger","table","spatula","barrelTSCP"],this.themeDict.food=["burger","burger","table","spatula","barrelTSCP"],this.themeDict.vehicles=["car2","bus2TSCP","train","train","boatTSCP","train"],this.themeDict.dungeon=["tiki_wood"],this.themeDict.statues=["rock","rock","rock","patrickStatue","spongehengeTSCP"],this.themeDecorateDict.normal=["swimmingRing","jellyNet","jellyfish3"],this.themeDecorateDict.food=["krabDollar","krabMenu","mrKrab","krabTable","spatula","barrelTSCP"],this.themeDecorateDict.bikini_bottom=["building1TSCP","building2TSCP"],this.themeDecorateDict.windy_food=["building1TSCP","building2TSCP"],this.themeDecorateDict.vehicles=["building1TSCP","building2TSCP"],this.themeDecorateDict.dungeon=["building1TSCP","building2TSCP"],this.themeDecorateDict.statues=["rock","tomb","patrickStatue","spongehengeTSCP"]}initSizeDict(){this.themeDict.all.forEach(t=>{this.sizeDict[t]=new n(1,1,1)}),this.sizeDict.pineapple_house=new n(2,3,2),this.sizeDict.lightHouseTSCP=new n(2,5,2),this.sizeDict.squidwardHouseTSCP=new n(2,4,2),this.sizeDict.chum_bucket=new n(2,4.5,2),this.sizeDict.krabTSCP=new n(4,3,3),this.sizeDict.bottom=new n(2,.3,2),this.sizeDict.boatTSCP=new n(1,1,2),this.sizeDict.busTSCP=new n(6,2,2),this.sizeDict.bus2TSCP=new n(5,2,2),this.sizeDict.car2=new n(1,1,2),this.sizeDict.train=new n(2,2.5,10),this.sizeDict.burger=new n(2,2,2),this.sizeDict.spatula=new n(.3,1,.3),this.sizeDict.barrelTSCP=new n(1,1,1),this.sizeDict.table=new n(1,.5,1),this.sizeDict.krabDollar=new n(.1,1,2),this.sizeDict.krabMenu=new n(3,3,.5),this.sizeDict.mrKrab=new n(2,2.5,1),this.sizeDict.krabSign=new n(1,3,1),this.sizeDict.krabTable=new n(2,1,2),this.sizeDict.rock=new n(3,3,3),this.sizeDict.pillar=new n(1.4,4,1.4),this.sizeDict.tiki_wood=new n(1.75,1.75,1.75),this.sizeDict.jelly_fish=new n(1.2,1.8,1.2),this.sizeDict.jellyNet=new n(1.2,2.5,1.2),this.sizeDict.jellyfish3=new n(1.5,2,1.5),this.sizeDict.hat=new n(.2,.5,.2),this.sizeDict.boat=new n(1,1,2),this.sizeDict.karen=new n(.4,1,.4),this.sizeDict.snailClock=new n(1.6,1.6,.8),this.sizeDict.house1=new n(1,2,1),this.sizeDict.clock=new n(2,5,2),this.sizeDict.bed=new n(1,1,2),this.sizeDict.tableTSCP=new n(3,1,3),this.sizeDict.chair1=new n(2,2,2),this.sizeDict.spongehengeTSCP=new n(1.2,1.8,.35),this.sizeDict.swimmingRing=new n(1.5,.5,1.5),this.sizeDict.checkPoint=new n(1,3.5,1),this.sizeDict.mill1=new n(5,5,5),this.sizeDict.mill2=new n(5,5,5),this.sizeDict.wooden_fence=new n(3,1.2,.1),this.sizeDict.building1TSCP=new n(2.5,5,2.5),this.sizeDict.building2TSCP=new n(3,6,3),console.log("generator initialized",this.themeDict)}initRotateDict(){this.themeDict.all.forEach(t=>{this.rotateDict[t]=new n(0,0,0)}),this.rotateDict.burger=new n(0,Math.PI/2,0),this.rotateDict.busTSCP=new n(0,3*Math.PI/2,0),this.rotateDict.bus2TSCP=new n(0,3*Math.PI/2,0),this.rotateDict.boatTSCP=new n(0,Math.PI/2,0),this.rotateDict.pattywagon=new n(0,Math.PI,0),this.rotateDict.car2=new n(0,Math.PI,0),this.rotateDict.spongehenge=new n(0,Math.PI,0),this.rotateDict.bed=new n(0,0,0),this.rotateDict.snailClock=new n(0,Math.PI,0),this.rotateDict.chair1=new n(0,Math.PI,0),this.rotateDict.hat=new n(0,Math.PI,0),this.rotateDict.clock=new n(0,Math.PI,0),this.rotateDict.patrickStatue=new n(0,Math.PI,0),this.rotateDict.squidwardHouseTSCP=new n(0,Math.PI,0),this.rotateDict.pineappleHouseTSCP=new n(0,Math.PI,0),this.rotateDict.pineapple_house=new n(0,Math.PI,0),this.rotateDict.krabTSCP=new n(0,Math.PI,0),this.rotateDict.house1=new n(0,Math.PI,0),this.rotateDict.tiki_wood=new n(0,Math.PI,0),this.rotateDict.jelly_fish=new n(0,Math.PI,0),this.rotateDict.jellyNet=new n(0,Math.PI,0),this.rotateDict.mrKrab=new n(0,Math.PI,0),this.rotateDict.krabPack=new n(0,Math.PI/2,0),this.rotateDict.krabDollar=new n(0,-Math.PI/2,0),this.rotateDict.krabMenu=new n(0,Math.PI,0)}initVelDict(){this.themeDict.all.forEach(t=>{this.velDict[t]=new n(0,0,0)}),this.velDict.train=new n(0,0,-1.5),this.velDict.bus2TSCP=new n(0,0,-1),this.velDict.boatTSCP=new n(.1,0,0),this.velDict.car2=new n(0,0,-2),this.velDict.rock=new n(0,-4,0),this.velDict.tiki_wood=new n(0,-1,0),this.velDict.jelly_fish=new n(1,0,0)}randomObstacle(t=-1,e="normal",i=NaN){let s,o;console.log("parse in  theme ",e),this.themes.includes(e)||(e="normal"),console.log("trying to randomObstacle from theme ",e);const{random:a,newSeed:h}=R(this.seed);this.seed=h,o=this.themeDict[e][Math.floor(a*this.themeDict[e].length)],j(d(this.gltfDict[o]).scene),s=new A(o+"_"+t,d(this.gltfDict[o])),(isNaN(i.x)||isNaN(i.y)||isNaN(i.z))&&(i=this.sizeDict[o]),s.rescale(i.x,i.y,i.z);{const r=new f().setFromObject(s.mesh);r.getSize(new n),console.log("new obstacle generated",s.name,r)}s.rotate("x",this.rotateDict[o].x),s.rotate("y",this.rotateDict[o].y),s.rotate("z",this.rotateDict[o].z);let c=this.velDict[o].clone();for(let r=0;r<3;r++){let m=(Math.random()-.5)*1.5;Math.random()>.5&&(m=-m),c.setComponent(r,c.getComponent(r)*Math.exp(m))}return s.vel=c,s}randomDecoration(t=-1,e="normal",i=NaN){let s,o;console.log("parse in  theme ",e),this.themes.includes(e)||(e="normal");const{random:a,newSeed:h}=R(this.seed);this.seed=h,o=this.themeDecorateDict[e][Math.floor(a*this.themeDecorateDict[e].length)],j(d(this.gltfDict[o]).scene),s=new A(o+"_"+t,d(this.gltfDict[o])),(isNaN(i.x)||isNaN(i.y)||isNaN(i.z))&&(i=this.sizeDict[o]),s.rescale(i.x,i.y,i.z);{const r=new f().setFromObject(s.mesh);r.getSize(new n),console.log("new obstacle generated",s.name,r)}s.rotate("x",this.rotateDict[o].x),s.rotate("y",this.rotateDict[o].y),s.rotate("z",this.rotateDict[o].z);let c=this.velDict[o].clone();for(let r=0;r<3;r++){let m=(Math.random()-.4)*1.5;Math.random()>.5&&(m=-m),c.setComponent(r,c.getComponent(r)*Math.exp(m))}return s.vel=c,s}centainObstacle(t,e=-1,i=NaN){let s;return s=new A(t+"_"+e,this.gltfDict[t]),(isNaN(i.x)||isNaN(i.y)||isNaN(i.z))&&(i=this.sizeDict[t]),s.rescale(i.x,i.y,i.z),s}}class M extends v{constructor(t,e){const i=d(e);super("item",t,i),this.init();const s=new lt(this.mesh.geometry),o=new mt({color:16777215});this.outlineMesh=new dt(s,o),this.mesh.add(this.outlineMesh)}init(){}tick(t){this.mesh.position.y+=Math.sin(Date.now()*.001*3)*.5*t,this.animate(t),this.updateBoundingBox()}}class _ extends M{constructor(t,e){super(t,e),this.effect={duration:5,apply:i=>{i.defaultMaxVel*=2},remove:i=>{i.defaultMaxVel/=2}}}applyEffect(t){t.pickEffect("speedBoost",this.effect)}}class E extends M{constructor(t,e){super(t,e),this.effect={duration:10,apply:i=>{i.defaultMaxJumpVel*=2},remove:i=>{i.defaultMaxJumpVel/=2}}}applyEffect(t){t.pickEffect("highJump",this.effect)}}class G extends M{constructor(t,e){super(t,e),this.effect={duration:10,apply:i=>{i.updateCondition("robotic")},remove:i=>{i.updateCondition("normal")}}}applyEffect(t){t.pickEffect("robotic",this.effect)}}class O extends M{constructor(t,e){super(t,e),this.effect={duration:3,apply:i=>{i.updateCondition("dance")},remove:i=>{i.updateCondition("normal")}}}applyEffect(t){t.applyEffect("dance",this.effect)}}class It extends M{constructor(t,e){super(t,e),this.effect={duration:1,apply:i=>{},remove:i=>{}}}applyEffect(t){}}class Bt{constructor(t){this.seed=0,this.gltfDict={},this.themes=["all","normal","bikini_bottom","vehicles","windy_food","statues","dungeon"],this.themeDict={},this.sizeDict={},this.rotationDict={},console.log("generator created"),this.gltfDict=t,this.init()}init(){this.seed=0,this.themes.forEach(t=>{this.themeDict[t]=[]});for(let t in this.gltfDict)this.themeDict.all.push(t);this.initSizeDict()}initSizeDict(){this.themeDict.all.forEach(t=>{this.sizeDict[t]=new n(1,1,1),this.rotationDict[t]=new n(0,0,0)}),this.sizeDict.sodaTSCP=new n(.6,1,.6),this.sizeDict.disco_ball=new n(.7,.05,.7),this.rotationDict.disco_ball=new n(-Math.PI/3,0,0),this.sizeDict.sauceTSCP=new n(.6,1,.6),this.sizeDict.infoSign=new n(1,1,.7),this.sizeDict.xbox_controller_lp=new n(.6,.6,.6),this.sizeDict.star=new n(.6,.6,.6),this.rotationDict.sodaTSCP=new n(0,Math.PI/2,0),this.rotationDict.sauceTSCP=new n(0,Math.PI/2,0),this.rotationDict.infoSign=new n(0,Math.PI,0),this.rotationDict.xbox_controller_lp=new n(0,Math.PI,0),this.rotationDict.star=new n(0,0,0),console.log("generator initialized",this.themeDict)}randomItem(t=-1,e="all",i=NaN){let s,o;e in this.themes||(e="all");const a=Math.random();o=this.themeDict[e][Math.floor(a*this.themeDict[e].length)],o.includes("soda")?s=new _(o+"_"+t,d(this.gltfDict[o])):o.includes("xbox")?s=new G(o+"_"+t,d(this.gltfDict[o])):o.includes("disco")?s=new O(o+"_"+t,d(this.gltfDict[o])):o.includes("sauce")?s=new E(o+"_"+t,d(this.gltfDict[o])):a<.25?s=new E("sodaTSCP_"+t,d(this.gltfDict[o])):a<.5?s=new _("sauceTSCP_"+t,d(this.gltfDict[o])):a<.75?s=new G("xbox_controller_lp_"+t,d(this.gltfDict[o])):s=new O("discoball_"+t,d(this.gltfDict[o])),(isNaN(i.x)||isNaN(i.y)||isNaN(i.z))&&(i=this.sizeDict[o]),s.rescale(i.x,i.y,i.z);{const h=new f().setFromObject(s.mesh);h.getSize(new n),console.log("new Item generated",s.name,h)}return s.rotate("x",this.rotationDict[o].x),s.rotate("y",this.rotationDict[o].y),s.rotate("z",this.rotationDict[o].z),s}centainItem(t,e=-1,i=NaN){let s;return t.includes("soda")?s=new _(t+"_"+e,d(this.gltfDict[t])):t.includes("info")?s=new G(t+"_"+e,d(this.gltfDict[t])):t.includes("sauce")?s=new E(t+"_"+e,d(this.gltfDict[t])):t.includes("star")?s=new It(t+"_"+e,d(this.gltfDict[t])):s=new O(t+"_"+e,d(this.gltfDict[t])),(isNaN(i.x)||isNaN(i.y)||isNaN(i.z))&&(i=this.sizeDict[t]),s.rescale(i.x,i.y,i.z),s}}class q extends P{constructor(t,e=10,i=10){console.log("createWall");const s=new F(e,i),o=new b({color:"transparent",side:k,transparent:!0,opacity:0}),a=new D(s,o);a.receiveShadow=!0,super("ground",t,a)}setAsLeftWall(){this.mesh.position.x=-3.4,this.mesh.rotation.y=Math.PI/2}setAsRightWall(){this.mesh.position.x=3.4,this.mesh.rotation.y=-Math.PI/2}}class Tt extends P{constructor(t,e=10,i=1e3,s=null,o=1,a=1){console.log("createGround");const h=new F(e,i);let c;s?(s.wrapS=z,s.wrapT=z,s.repeat.set(e/o,i/a),c=new b({map:s,side:k})):c=new b({color:8421504});const r=new D(h,c);r.rotation.x=-Math.PI/2,r.receiveShadow=!0,super("ground",t,r),this.createGround(e,i)}createGround(t=5,e=1e3){}}class Lt extends P{constructor(t,e=5,i=8){console.log("createCeiling");const s=new F(e,i),o=new b({color:"transparent",side:k,transparent:!0,opacity:0}),a=new D(s,o);a.rotation.x=Math.PI/2,a.receiveShadow=!0,super("ground",t,a),this.setCeiling(i)}setCeiling(t){this.mesh.position.y=t/2}}class At extends P{constructor(t,e=10,i=10,s=null,o=1,a=1){console.log("createDome");const h=e/2,c=i,r=32,m=1,p=!0,I=0,J=Math.PI,X=new ut(h,h,c,r,m,p,I,J);let B;s?(s.wrapS=z,s.wrapT=z,s.repeat.set(e/o,i/a),B=new b({map:s,side:k})):B=new b({color:8421504});const C=new D(X,B);C.rotation.z=Math.PI/2,C.rotation.y=Math.PI/2,C.receiveShadow=!0,super("dome",t,C)}setDome(t){this.mesh.position.y=t}}const x=20,_t=10,u=class u extends v{constructor(t,e,i,s,o,a={},h="all"){const c=new pt;super("stage",e,c),this.obstacles=[],this.items=[],this.theme="normal",this.themes=["normal","bikini_bottom","windy_food","vehicles","dungeon","statues"],this.length=200,this.nearestObstacles=[],this.obstaclePointerL=0,this.obstaclePointerR=0,this.nearestItems=[],this.itemPointerL=0,this.itemPointerR=0,this.textureDict={},this.specialIntervals=[],this.textureDict=a,this.obstacleGenerator=s,this.itemGenerator=o,this.mesh=c,this.length=u.LENGTH,h=="all"?this.theme=this.themes[Math.floor(Math.random()*this.themes.length)]:this.theme=h,console.log("theme:",this.theme),this.length*i,this.scene=t.getScene(),this.scene.add(this.mesh),this.leftWall=new q("leftWall",u.LENGTH,this.length),this.rightWall=new q("rightWall",u.LENGTH,this.length),this.ceiling=new Lt("ceiling",u.WIDTH,this.length);let[r,m,p]=this.theme2texture(this.theme,!0);this.ground=new Tt("ground",u.WIDTH*10,this.length,r,m,p),[r,m,p]=this.theme2texture(this.theme,!1),this.dome=new At("dome",u.WIDTH*5,this.length,r,m,p),this.ground.mesh.position.z=this.length/2-x,this.leftWall.mesh.position.z=this.length/2-x,this.rightWall.mesh.position.z=this.length/2-x,this.ceiling.mesh.position.z=this.length/2-x,this.dome.mesh.position.z=this.length/2-x,this.leftWall.setAsLeftWall(),this.rightWall.setAsRightWall(),this.ceiling.setCeiling(u.HEIGHT),this.mesh.add(this.ground.mesh),this.mesh.add(this.leftWall.mesh),this.mesh.add(this.rightWall.mesh),this.mesh.add(this.ceiling.mesh),this.mesh.add(this.dome.mesh),this.initStage(),this.initObstacles(this.length,u.WIDTH),this.initItems(this.length,u.WIDTH)}theme2texture(t,e){let i,s,o;return e?t=="vehicles"?(i=this.textureDict.road,s=7,o=7):t=="bikini_bottom"?(i=this.textureDict.sand,s=1,o=1):t=="food"?(i=this.textureDict.wood,s=2,o=2):(i=this.textureDict.grass,s=1,o=1):t=="statues"?(i=this.textureDict.flower,s=10,o=10):t=="bikini_bottom"?(i=this.textureDict.colorful,s=1,o=1):t=="food"?(i=this.textureDict.block,s=5,o=5):(i=this.textureDict.flower2,s=10,o=10),[i,s,o]}initStage(){}checkCollision(t,e){const i=new f().setFromObject(t.mesh);i.translate(e.clone().sub(t.mesh.position));const s=.2;i.min.sub(new n(s,s,s)),i.max.add(new n(s,s,s));for(const o of this.obstacles){const a=new f().setFromObject(o.mesh);if(i.intersectsBox(a))return!0}return!1}findValidPosition(t,e,i,s){for(let o=0;o<_t;o++){const a=Math.random()*e-e/2,h=0,c=i+Math.random()*s,r=new n(a,h,c);if(!this.checkCollision(t,r))return r}return null}initObstacles(t,e){const s=Math.floor(t/1.5);for(let o=0;o<s;o++){const a=this.obstacleGenerator.centainObstacle("wooden_fence");a.rotate("y",Math.PI/2),this.obstacles.push(a),this.mesh.add(a.mesh);const h=-3.5,c=0,r=o*1.5;a.setPosition(h,c,r)}for(let o=0;o<s;o++){const a=this.obstacleGenerator.centainObstacle("wooden_fence");a.rotate("y",-Math.PI/2),this.obstacles.push(a),this.mesh.add(a.mesh);const h=3.5,c=0,r=o*1.5;a.setPosition(h,c,r)}if(this.theme=="windy_food")for(let o=0;o<5;o++)if(Math.random()>=.5){const c=o*20;if(Math.random()>=.5){const r=this.obstacleGenerator.centainObstacle("mill1");r.rotate("y",Math.PI),this.obstacles.push(r),this.mesh.add(r.mesh),r.setPosition(6,-.1,c),this.specialIntervals.push([c-this.obstacleGenerator.sizeDict.mill1.z/2,c+this.obstacleGenerator.sizeDict.mill1.z/2,"wind_from_left"])}else{const r=this.obstacleGenerator.centainObstacle("mill2");this.obstacles.push(r),this.mesh.add(r.mesh),r.setPosition(6,-.1,c),this.specialIntervals.push([c-this.obstacleGenerator.sizeDict.mill2.z/2,c+this.obstacleGenerator.sizeDict.mill2.z/2,"wind_from_left"])}}else{const c=o*20;if(Math.random()>=.5){const r=this.obstacleGenerator.centainObstacle("mill1");this.obstacles.push(r),this.mesh.add(r.mesh),r.setPosition(-6,-.1,c),this.specialIntervals.push([c-this.obstacleGenerator.sizeDict.mill1.z/2,c+this.obstacleGenerator.sizeDict.mill1.z/2,"wind_from_right"])}else{const r=this.obstacleGenerator.centainObstacle("mill2");r.rotate("y",Math.PI),this.obstacles.push(r),this.mesh.add(r.mesh),r.setPosition(-6,-.1,c),this.specialIntervals.push([c-this.obstacleGenerator.sizeDict.mill2.z/2,c+this.obstacleGenerator.sizeDict.mill2.z/2,"wind_from_right"])}}else{const a=Math.floor(t/5);for(let h=0;h<a;h++){const c=this.obstacleGenerator.randomDecoration(h,this.theme);this.obstacles.push(c),this.mesh.add(c.mesh);let r=6;Math.random()>.5&&(r=-6),r+=(Math.random()-.5)*2;let m=0;(c.name.includes("Menu")||c.name.includes("jellyfish3"))&&(m=2+Math.random()*2);const p=h*5+(Math.random()-.5)*5;c.setPosition(r,m,p)}}if(this.theme=="statues")for(let o=0;o<s;o++){const a=this.obstacleGenerator.randomObstacle(o,this.theme),h=this.findValidPosition(a,e,o*4,4);h?(this.obstacles.push(a),this.mesh.add(a.mesh),a.name.includes("rock")?a.setPosition(h.x,h.y+30,h.z):a.setPosition(h.x,h.y,h.z)):a.destruct()}else if(this.theme=="dungeon"){for(let o=0;o<this.length/1.75;o++){const a=[-2.635,-.875,.875,2.635],h=0,c=o*1.75;for(let r=0;r<4;r++){const m=this.obstacleGenerator.randomObstacle(o*4+r,this.theme);this.obstacles.push(m),this.mesh.add(m.mesh),m.setPosition(a[r],h,c)}}for(let o=0;o<this.length/7.5;o++){const c=o*7.5,r=this.obstacleGenerator.randomObstacle(o,"normal");this.obstacles.push(r),this.mesh.add(r.mesh),r.setPosition(0,1.5,c)}}else for(let o=0;o<s;o++){const a=this.obstacleGenerator.randomObstacle(o,this.theme),h=this.findValidPosition(a,e,o*1.5,1.5);h?(this.obstacles.push(a),this.mesh.add(a.mesh),a.setPosition(h.x,h.y,h.z)):a.destruct()}for(this.obstacles.sort((o,a)=>o.getBottomCenter().z-a.getBottomCenter().z);this.obstacles.length>0&&this.obstacles[this.obstacles.length-1].getBottomCenter().z>this.length;)this.obstacles[this.obstacles.length-1].destruct(),this.obstacles.pop();this.obstaclePointerL=0,this.obstaclePointerR=1}initItems(t,e){const s=Math.floor(t/30);for(let h=0;h<s;h++){const c=this.itemGenerator.randomItem(h,this.theme);this.items.push(c),this.mesh.add(c.mesh);const r=Math.random()*e-e/2,m=.5+Math.random()*1.5,p=h*30+Math.random()*30;c.setPosition(r,m,p)}const o=30,a=Math.floor(t/o);for(let h=0;h<a;h++){const c=this.itemGenerator.centainItem("star",h);this.items.push(c),this.mesh.add(c.mesh);const r=Math.random()*e-e/2,m=.5+Math.random()*1.5,p=h*o+Math.random()*o;c.setPosition(r,m,p)}for(this.items.sort((h,c)=>h.getBottomCenter().z-c.getBottomCenter().z);this.items.length>0&&this.items[this.items.length-1].getBottomCenter().z>this.length;)this.items[this.items.length-1].destruct(),this.items.pop();this.itemPointerL=0,this.itemPointerR=1}updateNearestList(t,e=10){for(;this.obstaclePointerL>0&&this.obstacles[this.obstaclePointerL-1].getBottomCenter().z>t.z-e;)this.obstaclePointerL--;for(;this.obstaclePointerL<this.obstacles.length&&this.obstacles[this.obstaclePointerL].getBottomCenter().z<t.z-e;)this.obstaclePointerL++;for(;this.obstaclePointerR<this.obstacles.length&&this.obstacles[this.obstaclePointerR].getBottomCenter().z<t.z+e;)this.obstaclePointerR++;for(;this.obstaclePointerR>0&&(!this.obstacles[this.obstaclePointerR-1]||this.obstacles[this.obstaclePointerR-1].getBottomCenter().z>t.z+e);)this.obstaclePointerR--;for(this.nearestObstacles=this.obstacles.slice(this.obstaclePointerL,this.obstaclePointerR);this.itemPointerL>0&&this.items[this.itemPointerL-1].getBottomCenter().z>t.z-e;)this.itemPointerL--;for(;this.itemPointerL<this.items.length&&this.items[this.itemPointerL].getBottomCenter().z<t.z-e;)this.itemPointerL++;for(;this.itemPointerR<this.items.length&&this.items[this.itemPointerR].getBottomCenter().z<t.z+e;)this.itemPointerR++;for(;this.itemPointerR>0&&(!this.items[this.itemPointerR-1]||this.items[this.itemPointerR-1].getBottomCenter().z>t.z+e);)this.itemPointerR--;this.nearestItems=this.items.slice(this.itemPointerL,this.itemPointerR)}removeItem(t){this.items=this.items.filter(e=>e!==t),t.destruct(this.scene)}removeObstacle(t){this.obstacles=this.obstacles.filter(e=>e!==t),t.destruct(this.scene)}destruct(){this.ground.destruct(),this.leftWall.destruct(),this.rightWall.destruct(),this.ceiling.destruct(),this.obstacles.forEach(t=>{t.destruct()}),this.items.forEach(t=>{t.destruct()}),super.destruct()}reset(){this.obstacles.forEach(t=>{t.destruct()}),this.items.forEach(t=>{t.destruct()}),this.obstacles=[],this.items=[],this.initObstacles(u.LENGTH,u.WIDTH),this.initItems(u.LENGTH,u.WIDTH)}tick(t){this.nearestObstacles.forEach(e=>{e.tick(t)}),this.nearestItems.forEach(e=>{e.tick(t)})}};u.LENGTH=100,u.WIDTH=5,u.HEIGHT=15,u.START_Z=0;let S=u;class Et extends v{constructor(t,e){const i=d(e);super("enemy",t,i),this.init()}init(){}tick(t){this.animate(t),this.updateBoundingBox()}}class Gt{constructor(t,e,i,s,o={},a){this.stages=[],this.textureDict={},this.stageidx=0,this.totalTime=0,this.enemyMinVel=.4,this.enemyMaxVel=3,this.enemyDist=15,this.enemyPos=-20,this.collectedStars=0,this.scene=t,this.character=e,this.obstacleGenerator=i,this.itemGenerator=s,this.textureDict=o,this.uicontroller=a,this.audioManager=g.getInstance()}init(){for(let t of this.stages)t.destruct();this.stages=[],this.stages.push(new S(this.scene,"stage1",0,this.obstacleGenerator,this.itemGenerator,this.textureDict,this.getTheme())),this.stageidx=0,this.enemy=new Et("jellyKing",this.obstacleGenerator.gltfDict.fish),this.enemy.rescale(5,4,4),this.scene.getScene().add(this.enemy.mesh),this.enemy.setPosition(0,0,-20),this.initFog()}initFog(){this.scene.getScene().fog=new ft(8900346,.5,40);const t=new N(16777215,1);t.position.set(30,30,50),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,t.shadow.camera.near=.5,t.shadow.camera.far=500,t.shadow.camera.left=-50,t.shadow.camera.right=50,t.shadow.camera.top=50,t.shadow.camera.bottom=-50,this.directionLight=t,this.scene.getScene().add(this.directionLight)}getTheme(){return this.collectedStars<1?"normal":this.collectedStars<4?"food":this.collectedStars<7?"dungeon":this.collectedStars<11?"windy_food":this.collectedStars<15?"vehicles":this.collectedStars<20?"bikini_bottom":"statues"}changeStage(){console.log("change stage"),this.stageidx+=1,this.stages.push(new S(this.scene,"stage"+(this.stageidx+1),this.stageidx,this.obstacleGenerator,this.itemGenerator,this.textureDict,this.getTheme())),this.stages[this.stageidx].mesh.position.z=this.stages[this.stageidx-1].mesh.position.z+this.stages[this.stageidx-1].length,this.stageidx>1&&this.stages[this.stageidx-2].destruct()}getCharactorMovableBoundary(){let t={forward:1e3,backward:-1e3,left:-1e3,right:1e3,up:1e3,down:0},e=this.stages[this.stageidx];for(let i of e.nearestObstacles)W(this.character,i,t);t.up=Math.min(t.up,e.ceiling.mesh.position.y),t.down=Math.max(t.down,e.ground.mesh.position.y),t.left=Math.max(t.left,e.leftWall.mesh.position.x),t.right=Math.min(t.right,e.rightWall.mesh.position.x),this.stageidx>0&&(e=this.stages[this.stageidx-1]);for(let i of e.nearestObstacles)W(this.character,i,t);t.up=Math.min(t.up,e.ceiling.mesh.position.y),t.down=Math.max(t.down,e.ground.mesh.position.y),t.left=Math.max(t.left,e.leftWall.mesh.position.x),t.right=Math.min(t.right,e.rightWall.mesh.position.x),this.character.movableBoundary=t}checkCollisionItems(t){for(let e of t.nearestItems)if(T(this.character,e)){if(this.audioManager.playPickItemSound(),console.log("collide with item ",e.name),e.applyEffect(this.character),e.name.includes("xbox"))this.uicontroller.swapItem("metal");else if(e.name.includes("soda"))this.uicontroller.swapItem("green");else if(e.name.includes("sauce"))this.uicontroller.swapItem("pink");else if(e.name.includes("star")){this.collectedStars+=1;const i=document.getElementById("star-count");i&&(i.textContent=this.collectedStars.toFixed(0))}t.removeItem(e)}this.character.waiting_effect[0]==""&&this.uicontroller.swapItem("none")}checkCollisionObstacles(t,e){for(let i of t.nearestObstacles)T(this.character,i)?(console.log("collide with obstacle "+i.name),this.character.condition=="robotic"?(this.audioManager.playBreakSound(),t.removeObstacle(i)):i.name.includes("bottom")?(this.audioManager.playBoundingSound(),this.character.vel.y=this.character.defaultMaxJumpVel):(i.colliding||(i.colliding=!0,i.collidedCnt++),i.collidedCnt>=i.collidedThreshold&&(this.audioManager.playBreakSound(),t.removeObstacle(i)),this.character.movement=="punching"&&(i.punchedTime+=e),i.punchedTime>1.5&&(this.audioManager.playBreakSound(),t.removeObstacle(i)))):i.colliding=!1}checkSquash(){for(let t of this.stages)if(t.theme=="statues"){for(let e of t.nearestObstacles)if(e.name.includes("rock")&&this.character.mesh.position.z>t.mesh.position.z+e.mesh.position.z-1.5&&this.character.mesh.position.z<t.mesh.position.z+e.mesh.position.z+1.5&&this.character.mesh.position.y<e.getBottomCenter().y&&this.character.mesh.position.y>e.getBottomCenter().y-2&&this.character.mesh.position.x>e.mesh.position.x-1.5&&this.character.mesh.position.x<e.mesh.position.x+1.5){const i={duration:3,apply:s=>{s.updateCondition("squashed")},remove:s=>{s.updateCondition("normal")}};this.character.applyEffect("squashed",i)}}}checkPositionState(){for(let t of this.stages)for(let e of t.specialIntervals)if(this.character.mesh.position.z>e[0]+t.mesh.position.z&&this.character.mesh.position.z<e[1]+t.mesh.position.z){if(e[2]=="wind_from_left"){const i={duration:.3,apply:h=>{h.force.x-=3},remove:h=>{h.force.x+=3}};this.character.applyEffect("windy",i);const s=new H,o=new n(this.character.mesh.position.x-5,this.character.mesh.position.y-5,this.character.mesh.position.z-5),a=new n(this.character.mesh.position.x+5,this.character.mesh.position.y+5,this.character.mesh.position.z+5);s.createWindEffect(o,a,50,.5,new n(-2,0,0)),this.scene.getScene().add(s.particles),s.addToUpdateList(this.scene.getScene())}if(e[2]=="wind_from_right"){const i={duration:.3,apply:h=>{h.force.x+=3},remove:h=>{h.force.x-=3}};this.character.applyEffect("windy",i);const s=new H,o=new n(this.character.mesh.position.x-5,this.character.mesh.position.y-5,this.character.mesh.position.z-5),a=new n(this.character.mesh.position.x+5,this.character.mesh.position.y+5,this.character.mesh.position.z+5);s.createWindEffect(o,a,50,.5,new n(2,0,0)),this.scene.getScene().add(s.particles),s.addToUpdateList(this.scene.getScene())}}}checkToChangeStage(){this.character.getBottomCenter().z+70>this.stages[this.stageidx].length+this.stages[this.stageidx].mesh.position.z&&this.changeStage()}updateFog(){this.directionLight.position.set(30,30,this.character.mesh.position.z+10)}tick(t){this.stages[this.stageidx].updateNearestList(this.character.mesh.position.clone(),20),this.stages[this.stageidx].tick(t),this.checkSquash(),this.checkPositionState(),this.checkCollisionObstacles(this.stages[this.stageidx],t),this.checkCollisionItems(this.stages[this.stageidx]),this.stageidx>0&&(this.stages[this.stageidx-1].tick(t),this.stages[this.stageidx-1].updateNearestList(this.character.mesh.position.clone(),20),this.checkCollisionObstacles(this.stages[this.stageidx-1],t),this.checkCollisionItems(this.stages[this.stageidx-1])),this.getCharactorMovableBoundary(),this.checkToChangeStage(),this.updateFog(),this.totalTime+=t;const e=document.getElementById("distance-value");e&&(e.textContent=this.character.mesh.position.z.toFixed(0)),this.enemy.tick(t);const i=this.enemyMinVel+(this.enemyMaxVel-this.enemyMinVel)*((this.character.mesh.position.z-this.enemyPos)/this.enemyDist);this.enemyPos+=i*t,this.enemyPos=Math.max(this.enemyPos,this.character.mesh.position.z-this.enemyDist),this.enemy.setPosition(0,0,this.enemyPos);const s=new f().setFromObject(this.enemy.mesh),o=Math.abs(this.character.mesh.position.z-s.max.z);o<2&&o>1.95&&this.audioManager.playWarningSound();const a=document.getElementById("distance-bar-fill"),h=document.getElementById("s-icon");if(a&&h){const c=this.enemyDist,r=Math.min(o/c,1);a.style.height=`${r*100}%`,h.style.bottom=`${r*100}%`;const m=Math.round(255*(1-r)),p=Math.round(255*r),I=`rgb(${m}, ${p}, 0)`;a.style.backgroundColor=I}T(this.character,this.enemy)&&document.dispatchEvent(new CustomEvent("gameover",{detail:{obstacle:"killed by enemy"}}))}}class Ot{constructor(){this.controllerListForLoop=[],this.gltfCharacterDict={},this.gltfObstacleDict={},this.gltfItemDict={},this.audioDict={},this.textureDict={},this.CharacterListForLoop=[],this.init()}async init(){this.status="paused",this.uiController=new xt,this.uiController.loadingScreen(),await bt(this.gltfCharacterDict,this.gltfObstacleDict,this.gltfItemDict,this.textureDict),this.audioManager=g.getInstance(),this.scene=new Pt,this.obstacleGenerator=new kt(this.gltfObstacleDict),this.itemGenerator=new Bt(this.gltfItemDict),this.initCharacter(),this.controller=new Gt(this.scene,this.Character,this.obstacleGenerator,this.itemGenerator,this.textureDict,this.uiController),this.camera=this.Character.camera,this.renderer=new vt,this.loop=new wt(this.scene,this.camera,this.renderer),document.getElementById("scene-container").appendChild(this.renderer.domElement),this.cameraController=new yt(this.camera,this.renderer.domElement),this.uiController.removeLoadingScreen(),await this.audioManager.loadAndPlayBGM(),this.reset(),this.start(),this.pause(),await this.uiController.countdown(5),this.status="playing",this.resume(),this.registerEventHandlers()}reset(){this.Character.reset(),this.controller.init(),this.loop.updatableLists=[],this.CharacterListForLoop=[this.Character],this.controllerListForLoop=[this.controller],console.log("length of list for loop",this.controllerListForLoop.length),this.loop.updatableLists.push(this.CharacterListForLoop),this.loop.updatableLists.push(this.controllerListForLoop)}start(){this.loop.start()}pause(){const t=this.loop.updatableLists.indexOf(this.CharacterListForLoop);t!==-1&&this.loop.updatableLists.splice(t,1);const e=this.loop.updatableLists.indexOf(this.controllerListForLoop);e!==-1&&this.loop.updatableLists.splice(e,1),console.log("pausing ",this.loop.updatableLists)}resume(){this.loop.updatableLists.indexOf(this.CharacterListForLoop)===-1&&this.loop.updatableLists.push(this.CharacterListForLoop),this.loop.updatableLists.indexOf(this.controllerListForLoop)===-1&&this.loop.updatableLists.push(this.controllerListForLoop),console.log("resuming ",this.loop.updatableLists)}initCharacter(){if(localStorage.getItem("selectedCharacter")==="spongebob"){const e=new zt("spongeBob",this.gltfCharacterDict);e.rescale(1,1,1),this.Character=e,this.scene.getScene().add(this.Character.mesh),e.mesh.position.set(0,0,3)}else{const e=new St("patrick",this.gltfCharacterDict);e.rescale(1,1,1),this.Character=e,this.scene.getScene().add(this.Character.mesh),e.mesh.position.set(0,0,3)}}registerEventHandlers(){window.addEventListener("click",()=>{this.status==="paused"?(this.status="playing",this.resume(),this.uiController.resume()):this.status==="playing"&&(this.status="paused",this.pause(),this.uiController.pause())}),document.addEventListener("gameover",t=>{t instanceof CustomEvent&&(this.pause(),this.status="gameover",this.uiController.lose(),console.log("gameover",t.detail.obstacle))})}}function Nt(){const l=new Ot;window.game=l}Nt();
